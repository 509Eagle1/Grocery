<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grocery Master List</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
h1 { text-align: center; }
button { margin: 5px; padding: 8px 14px; border-radius: 8px; border: none; background: #007bff; color: white; font-size: 14px; }
button:hover { background: #0056b3; }
.list-container { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
.item { display: flex; justify-content: space-between; align-items: center; padding: 6px; border-bottom: 1px solid #ddd; }
.item.checked { text-decoration: line-through; color: gray; }
input[type="text"], input[type="number"] { padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
#aisle { width: 60px; }
</style>
</head>
<body>

<h1>üõí Grocery Master List</h1>

<div class="list-container">
  <button id="exportJsonBtn">Export List</button>
  <button id="importListBtn">Import List</button>
  <button id="restoreGitHubBtn">Restore from GitHub</button>
  <input type="file" id="importListInput" accept=".json,.csv" style="display:none;">
  <button id="clearChecksBtn">Clear All Checks</button>
  <hr>

  <div id="masterList"></div>
</div>

<script>
let groceryItems = JSON.parse(localStorage.getItem('groceryItems')) || [];
let checkedAisle = JSON.parse(localStorage.getItem('checkedAisle')) || [];

// --- Save data to localStorage ---
function saveData() {
  localStorage.setItem('groceryItems', JSON.stringify(groceryItems));
  localStorage.setItem('checkedAisle', JSON.stringify(checkedAisle));
}

// --- Render Master List ---
function renderMaster() {
  const list = document.getElementById('masterList');
  list.innerHTML = '';

  const aisles = [...new Set(groceryItems.map(i => i.aisle))].sort((a, b) => a - b);

  aisles.forEach(aisle => {
    const aisleDiv = document.createElement('div');
    const aisleHeader = document.createElement('h3');
    aisleHeader.textContent = `Aisle ${aisle}`;
    aisleDiv.appendChild(aisleHeader);

    const items = groceryItems.filter(i => i.aisle === aisle);
    items.forEach(item => {
      const div = document.createElement('div');
      div.className = 'item';
      if (checkedAisle.includes(item.name)) div.classList.add('checked');

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = checkedAisle.includes(item.name);
      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          checkedAisle.push(item.name);
          div.classList.add('checked');
          div.parentNode.appendChild(div); // move to bottom of aisle
        } else {
          checkedAisle = checkedAisle.filter(i => i !== item.name);
          div.classList.remove('checked');
        }
        saveData();
      });

      const name = document.createElement('span');
      name.textContent = item.name;

      div.appendChild(checkbox);
      div.appendChild(name);
      aisleDiv.appendChild(div);
    });

    list.appendChild(aisleDiv);
  });
}

// --- Clear all checks ---
document.getElementById('clearChecksBtn').addEventListener('click', () => {
  checkedAisle = [];
  saveData();
  renderMaster();
});

// --- Import from JSON/CSV ---
document.getElementById('importListBtn').addEventListener('click', () => {
  document.getElementById('importListInput').click();
});

document.getElementById('importListInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    let newItems = [];
    if (file.name.endsWith('.json')) {
      newItems = JSON.parse(ev.target.result).groceryItems || [];
    } else if (file.name.endsWith('.csv')) {
      const lines = ev.target.result.split('\n').filter(Boolean);
      lines.forEach(line => {
        const [name, aisle] = line.split(',').map(v => v.trim());
        if (name && aisle) newItems.push({ name, aisle });
      });
    }

    // Prevent duplicates
    const names = new Set(groceryItems.map(i => i.name.toLowerCase()));
    newItems.forEach(item => {
      if (!names.has(item.name.toLowerCase())) groceryItems.push(item);
    });

    // Sort by aisle number
    groceryItems.sort((a, b) => a.aisle - b.aisle);

    saveData();
    renderMaster();
    alert('‚úÖ Import complete!');
  };
  reader.readAsText(file);
});

// --- Export to JSON and push to GitHub ---
async function exportToGitHub() {
  const owner = "YOUR_GITHUB_USERNAME";
  const repo = "YOUR_REPOSITORY_NAME";
  const path = "grocery-list.json";
  const token = prompt("Enter your GitHub Personal Access Token");

  if (!token) return alert("‚ùå No token entered.");

  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
  const data = JSON.stringify({ groceryItems, checkedAisle }, null, 2);

  try {
    // Get current SHA (required for update)
    const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
    const fileData = res.ok ? await res.json() : {};
    const sha = fileData.sha || null;

    const updateRes = await fetch(url, {
      method: "PUT",
      headers: {
        Authorization: `token ${token}`,
        Accept: "application/vnd.github+json",
      },
      body: JSON.stringify({
        message: "Update grocery-list.json",
        content: btoa(data),
        sha: sha,
      }),
    });

    if (!updateRes.ok) {
      const err = await updateRes.text();
      throw new Error(err);
    }

    // Also trigger local download
    const blob = new Blob([data], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'grocery-list.json';
    a.click();
    URL.revokeObjectURL(a.href);

    alert("‚úÖ Exported and uploaded to GitHub!");
  } catch (err) {
    console.error(err);
    alert("‚ùå Error uploading to GitHub. Check console.");
  }
}

document.getElementById('exportJsonBtn').addEventListener('click', exportToGitHub);

// --- Restore from GitHub ---
async function restoreFromGitHub() {
  const owner = "YOUR_GITHUB_USERNAME";
  const repo = "YOUR_REPOSITORY_NAME";
  const path = "grocery-list.json";
  const token = prompt("Enter your GitHub Personal Access Token");

  if (!token) return alert("‚ùå No token entered.");

  try {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      headers: { Authorization: `token ${token}`, Accept: "application/vnd.github.v3+json" },
    });
    if (!res.ok) throw new Error(await res.text());

    const data = await res.json();
    const decoded = atob(data.content);
    const jsonData = JSON.parse(decoded);

    groceryItems = jsonData.groceryItems || [];
    checkedAisle = jsonData.checkedAisle || [];

    saveData();
    renderMaster();
    alert("‚úÖ Master list restored from GitHub!");
  } catch (err) {
    console.error(err);
    alert("‚ùå Error restoring from GitHub.");
  }
}

document.getElementById('restoreGitHubBtn').addEventListener('click', restoreFromGitHub);

// --- Load on startup ---
document.addEventListener('DOMContentLoaded', renderMaster);
</script>
</body>
</html>
