<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grocery Master List</title>
<style>
body { font-family: Arial, sans-serif; margin:10px; background:#f4f4f4; }
h1 { text-align:center; margin-bottom:5px; }
.menu { display:flex; gap:5px; justify-content:center; margin-bottom:10px; flex-wrap:wrap; }
.menu button, .menu .dropdown-btn { padding:8px 12px; border-radius:8px; border:none; background:#007bff; color:white; font-size:14px; cursor:pointer; }
.menu button:hover, .menu .dropdown-btn:hover { background:#0056b3; }
.status-icon { text-align:center; font-size:12px; color:#333; margin-bottom:2px; }
.button-bar { display:flex; flex-wrap:wrap; gap:5px; justify-content:flex-start; align-items:center; margin-bottom:10px; }
.button-bar button { padding:6px 10px; border-radius:6px; border:none; color:white; cursor:pointer; }
.button-bar .clear { background:#ffc107; color:#000; }
.button-bar .add { background:#17a2b8; }
.list-container { background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
.item { display:flex; justify-content:space-between; align-items:center; padding:6px; border-bottom:1px solid #ddd; position:relative; }
.item.checked { text-decoration: line-through; color:gray; }
input[type="text"] { padding:5px; border-radius:5px; border:1px solid #ccc; margin-bottom:5px; }
#addPage { display:flex; flex-direction:column; gap:5px; flex-wrap:wrap; align-items:flex-start; margin-top:10px; }
.hidden { display:none; }

/* Dropdown styling */
.dropdown { position: relative; display:inline-block; }
.dropdown-btn { background:#007bff; color:white; border:none; padding:4px 8px; border-radius:5px; cursor:pointer; font-size:12px; }
.dropdown-btn:hover { background:#0056b3; }
.dropdown-content { display:none; position:absolute; right:0; background-color:#f9f9f9; min-width:140px; box-shadow:0 8px 16px rgba(0,0,0,0.2); z-index:1; border-radius:5px; }
.dropdown-content button { width:100%; text-align:left; border:none; padding:6px 10px; cursor:pointer; font-size:12px; margin:0; border-radius:0; white-space:normal; word-wrap:break-word; }
.dropdown-content button:hover { opacity:0.9; }
.dropdown-content .edit { background:#28a745; color:white; margin-bottom:5px; }
.dropdown-content .remove { background:#dc3545; color:white; }

/* Search */
.search-container { position: relative; flex:1; max-width:300px; }
#searchInput { width:100%; padding-right: 25px; box-sizing: border-box; }
.clear-search { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; font-weight: bold; color: #888; font-size: 16px; display: none; }
.clear-search:hover { color: #333; }

/* Drag handle using SVG */
.drag-handle {
  cursor: grab;
  margin-left: 8px;
  user-select: none;
}
.drag-handle svg {
  width: 16px;
  height: 16px;
  fill: #666;
}
.drag-handle:active svg {
  fill: #000;
}
.item.dragging {
  opacity: 0.5;
  background: #e0e0e0;
}

/* Shopping list left alignment */
#checkedList .item {
  justify-content: flex-start;
  gap: 8px;
}
</style>
</head>
<body>

<h1>Albertsons</h1>
<div id="tokenStatus" class="status-icon">⚠️ No GitHub Token</div>

<div class="menu">
  <button id="showMasterBtn">Albertsons</button>
  <button id="showCheckedBtn">Shopping List</button>
  <button id="showAddBtn">Add Items</button>
  <div class="dropdown">
    <button class="dropdown-btn">Admin ⏷</button>
    <div class="dropdown-content">
      <button id="exportJsonBtn">Export</button>
      <button id="restoreGitHubBtn">Restore</button>
      <button id="importListBtn">Import List</button>
      <button id="setTokenBtn">Set GitHub Token</button>
      <button id="loadTokenFileBtn">Load Token From File</button>
    </div>
  </div>
</div>

<div class="list-container">
  <div id="masterPage">
    <div class="button-bar">
      <button id="clearChecksBtn" class="clear">Clear All Checks</button>
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search items...">
        <span id="clearSearchBtn" class="clear-search">×</span>
      </div>
    </div>
    <ul id="groceryList"></ul>
  </div>

  <div id="checkedPage" class="hidden">
    <ul id="checkedList"></ul>
  </div>

  <div id="addPage" class="hidden">
    <input type="text" id="itemInput" placeholder="Item name">
    <input type="text" id="aisleInput" placeholder="Aisle">
    <button id="addItemBtn" class="add">Add Item</button>
  </div>
</div>

<input type="file" id="importListInput" accept=".json,.csv" style="display:none;">
<input type="file" id="tokenFileInput" accept=".txt" style="display:none;">

<script>
let groceryItems = JSON.parse(localStorage.getItem('groceryItems') || "[]");

// ===== Save / Load =====
function saveData() { localStorage.setItem('groceryItems', JSON.stringify(groceryItems)); }

// ===== GitHub Token =====
function promptGitHubToken() {
  let token = localStorage.getItem("githubToken");
  if (!token) token = prompt("⚠️ GitHub token missing! Enter token:") || null;
  if(token) localStorage.setItem("githubToken", token);
  document.getElementById("tokenStatus").textContent = token ? "✅ GitHub Token Set" : "⚠️ No GitHub Token";
}

// ===== Render Master List =====
function renderMaster(filter="") {
  const list = document.getElementById("groceryList");
  list.innerHTML = "";

  groceryItems.forEach((item,index)=>{
    if(filter && !item.name.toLowerCase().includes(filter.toLowerCase())) return;

    const li = document.createElement("li");
    li.className="item";
    li.draggable = true;
    li.dataset.index = index;

    const leftDiv = document.createElement("div");
    leftDiv.style.display="flex";
    leftDiv.style.alignItems="center";
    leftDiv.style.gap="5px";

    const checkbox = document.createElement("input");
    checkbox.type="checkbox";
    checkbox.checked=item.checked || false;
    checkbox.addEventListener("change",()=>{
      item.checked = checkbox.checked;
      renderChecked();
      saveData();
    });

    const span = document.createElement("span");
    span.textContent=`${item.name} (Aisle: ${item.aisle})`;
    leftDiv.appendChild(checkbox);
    leftDiv.appendChild(span);
    li.appendChild(leftDiv);

    // Right side: dropdown + drag handle
    const rightDiv = document.createElement("div");
    rightDiv.style.display="flex";
    rightDiv.style.alignItems="center";

    const dropdown = document.createElement("div");
    dropdown.className="dropdown";
    const dropBtn = document.createElement("button");
    dropBtn.className="dropdown-btn";
    dropBtn.textContent="Options ⏷";
    const dropContent = document.createElement("div");
    dropContent.className="dropdown-content";

    const editBtn = document.createElement("button");
    editBtn.className="edit";
    editBtn.textContent="Edit";
    editBtn.addEventListener("click",()=>{
      const newName = prompt("Edit item:",item.name);
      if(newName!==null)item.name=newName.trim();
      const newAisle = prompt("Edit aisle:",item.aisle);
      if(newAisle!==null)item.aisle=newAisle.trim();
      renderMaster(document.getElementById("searchInput").value);
      saveData();
    });

    const removeBtn = document.createElement("button");
    removeBtn.className="remove";
    removeBtn.textContent="Remove";
    removeBtn.addEventListener("click",(e)=>{
      e.stopPropagation();
      if(confirm(`Are you sure you want to remove "${item.name}"?`)){
        groceryItems.splice(index,1);
        saveData();
        renderMaster(document.getElementById("searchInput").value);
      }
    });

    dropContent.appendChild(editBtn);
    dropContent.appendChild(removeBtn);
    dropdown.appendChild(dropBtn);
    dropdown.appendChild(dropContent);
    rightDiv.appendChild(dropdown);

    // Drag handle (SVG grip)
    const handle = document.createElement("span");
    handle.className = "drag-handle";
    handle.innerHTML = `
      <svg viewBox="0 0 20 20">
        <circle cx="5" cy="4" r="2"></circle>
        <circle cx="5" cy="10" r="2"></circle>
        <circle cx="5" cy="16" r="2"></circle>
      </svg>
    `;
    rightDiv.appendChild(handle);

    li.appendChild(rightDiv);

    dropBtn.addEventListener("click",(e)=>{
      e.stopPropagation();
      const isVisible = dropContent.style.display==="block";
      document.querySelectorAll(".dropdown-content").forEach(dc=>dc.style.display="none");
      dropContent.style.display = isVisible ? "none" : "block";
    });

    // Drag & Drop Events
    handle.addEventListener("mousedown",(e)=>{ li.draggable=true; });
    handle.addEventListener("mouseup",(e)=>{ li.draggable=false; });

    li.addEventListener("dragstart",(e)=>{
      li.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", index);
    });

    li.addEventListener("dragend",()=>{ li.classList.remove("dragging"); });

    li.addEventListener("dragover",(e)=>{
      e.preventDefault();
      const draggingItem = document.querySelector(".dragging");
      const bounding = li.getBoundingClientRect();
      const offset = e.clientY - bounding.top;
      const mid = bounding.height / 2;
      const listEl = li.parentNode;
      if(offset > mid){
        listEl.insertBefore(draggingItem, li.nextSibling);
      } else {
        listEl.insertBefore(draggingItem, li);
      }
    });

    li.addEventListener("drop",()=>{
      const newOrder = Array.from(document.querySelectorAll("#groceryList .item")).map(el=>{
        return groceryItems[el.dataset.index];
      });
      groceryItems = newOrder;
      saveData();
      renderMaster(document.getElementById("searchInput").value);
    });

    list.appendChild(li);
  });
}

// ===== Render Checked / Shopping List =====
function renderChecked() {
  const checkedList = document.getElementById("checkedList");
  checkedList.innerHTML = "";

  groceryItems.filter(i => i.checked).forEach(item => {
    const li = document.createElement("li");
    li.className = "item";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = false; // always start unchecked
    cb.addEventListener("change", () => {
      li.classList.toggle("checked", cb.checked);
    });

    const span = document.createElement("span");
    span.textContent=`${item.name} (Aisle: ${item.aisle})`;

    li.appendChild(cb);
    li.appendChild(span);
    checkedList.appendChild(li);
  });
}

// ===== Add Item =====
function addItem() {
  const name = document.getElementById("itemInput").value.trim();
  const aisle = document.getElementById("aisleInput").value.trim();
  if(!name) return;
  groceryItems.push({name,aisle,checked:false});
  document.getElementById("itemInput").value = "";
  document.getElementById("aisleInput").value="";
  saveData();
  renderMaster();
}

// ===== Page Switching =====
function showMaster(){ document.getElementById("masterPage").classList.remove("hidden"); document.getElementById("checkedPage").classList.add("hidden"); document.getElementById("addPage").classList.add("hidden"); }
function showChecked(){ document.getElementById("masterPage").classList.add("hidden"); document.getElementById("checkedPage").classList.remove("hidden"); document.getElementById("addPage").classList.add("hidden"); }
function showAdd(){ document.getElementById("addPage").classList.remove("hidden"); document.getElementById("masterPage").classList.add("hidden"); document.getElementById("checkedPage").classList.add("hidden"); }

document.addEventListener("DOMContentLoaded",()=>{
  promptGitHubToken();
  renderMaster();
  renderChecked();

  document.getElementById("addItemBtn").addEventListener("click",addItem);
  document.getElementById("clearChecksBtn").addEventListener("click",()=>{
    groceryItems.forEach(i=>i.checked=false);
    saveData();
    renderMaster();
    renderChecked();
  });
  document.getElementById("showMasterBtn").addEventListener("click",showMaster);
  document.getElementById("showCheckedBtn").addEventListener("click",showChecked);
  document.getElementById("showAddBtn").addEventListener("click",showAdd);

  const searchInput=document.getElementById("searchInput");
  const clearSearchBtn=document.getElementById("clearSearchBtn");
  searchInput.addEventListener("input",()=>{ renderMaster(searchInput.value); clearSearchBtn.style.display = searchInput.value ? 'block' : 'none'; });
  clearSearchBtn.addEventListener("click",()=>{ searchInput.value=''; renderMaster(); clearSearchBtn.style.display='none'; });

  document.addEventListener("click",()=>{ document.querySelectorAll(".dropdown-content").forEach(dc=>dc.style.display="none"); });
});
</script>
</body>
</html>
