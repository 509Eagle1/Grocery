<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grocery Master List</title>
<style>
body { font-family: Arial, sans-serif; margin:10px; background:#f4f4f4; }
h1 { text-align:center; margin-bottom:5px; }
.status-icon { text-align:center; font-size:12px; color:#333; margin-bottom:2px; }
.menu { display:flex; gap:5px; justify-content:center; margin-bottom:10px; flex-wrap:wrap; }
.menu button, .menu .dropdown-btn { padding:8px 12px; border-radius:8px; border:none; background:#007bff; color:white; font-size:14px; cursor:pointer; }
.menu button:hover, .menu .dropdown-btn:hover { background:#0056b3; }
.button-bar { display:flex; flex-wrap:wrap; gap:5px; justify-content:flex-start; align-items:center; margin-bottom:10px; }
.button-bar button { padding:6px 10px; border-radius:6px; border:none; color:white; cursor:pointer; }
.button-bar .clear { background:#ffc107; color:#000; }
.button-bar .add { background:#17a2b8; }
.dropdown { position:relative; display:inline-block; }
.dropdown-content { display:none; position:absolute; background-color:#f9f9f9; min-width:160px; box-shadow:0 8px 16px rgba(0,0,0,0.2); z-index:1; border-radius:5px; }
.dropdown-content button { color:black; background:white; padding:8px 12px; width:100%; text-align:left; border:none; cursor:pointer; }
.dropdown-content button:hover { background:#ddd; }
.dropdown:hover .dropdown-content { display:block; }
.list-container { background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
.item { display:flex; justify-content:space-between; align-items:center; padding:6px; border-bottom:1px solid #ddd; }
.item.checked { text-decoration: line-through; color:gray; }
input[type="text"] { padding:5px; border-radius:5px; border:1px solid #ccc; margin-bottom:5px; }
#addPage { display:flex; gap:5px; flex-wrap:wrap; align-items:center; margin-top:10px; }
.hidden { display:none; }

/* Search field with clear button */
.search-container { position: relative; flex-grow:1; margin-left:auto; max-width:300px; }
#searchInput { width:100%; padding-right:25px; box-sizing:border-box; }
.clear-search { position:absolute; right:5px; top:50%; transform:translateY(-50%); cursor:pointer; font-weight:bold; color:#888; font-size:16px; display:none; }
.clear-search:hover { color:#333; }
</style>
</head>
<body>

<h1>Albertsons</h1>
<div id="tokenStatus" class="status-icon">⚠️ No GitHub Token</div>

<div class="menu">
  <button id="showMasterBtn">Albertsons</button>
  <button id="showCheckedBtn">Shopping List</button>
  <button id="showAddBtn">Add Items</button>
  <div class="dropdown">
    <button class="dropdown-btn">Admin ⏷</button>
    <div class="dropdown-content">
      <button id="exportJsonBtn">Export</button>
      <button id="restoreGitHubBtn">Restore</button>
      <button id="importListBtn">Import List</button>
      <button id="setTokenBtn">Set GitHub Token</button>
      <button id="loadTokenFileBtn">Load Token From File</button>
    </div>
  </div>
</div>

<div class="list-container">
  <div id="masterPage">
    <div class="button-bar">
      <button id="clearChecksBtn" class="clear">Clear All Checks</button>
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search items...">
        <span id="clearSearchBtn" class="clear-search">×</span>
      </div>
    </div>
    <ul id="groceryList"></ul>
  </div>

  <div id="checkedPage" class="hidden">
    <ul id="checkedList"></ul>
  </div>

  <div id="addPage" class="hidden">
    <input type="text" id="itemInput" placeholder="Item name">
    <input type="text" id="aisleInput" placeholder="Aisle">
    <button id="addItemBtn" class="add">Add Item</button>
  </div>
</div>

<input type="file" id="importListInput" accept=".json,.csv" style="display:none;">
<input type="file" id="tokenFileInput" accept=".txt" style="display:none;">

<script>
const githubUser = "509Eagle1";
const repoName = "Grocery";
const filePath = "data/grocery.json";

let groceryItems = JSON.parse(localStorage.getItem('groceryItems') || "[]");
let checkedAisle = JSON.parse(localStorage.getItem('checkedAisle') || "[]");

// --- Save Data ---
function saveData() {
  localStorage.setItem('groceryItems', JSON.stringify(groceryItems));
  localStorage.setItem('checkedAisle', JSON.stringify(checkedAisle));
}
function sortByAisle(arr){ return arr.sort((a,b)=>a.aisle.localeCompare(b.aisle, undefined, {numeric:true,sensitivity:'base'})); }

// --- Token Status ---
function updateTokenStatus(token) {
  const status = document.getElementById('tokenStatus');
  status.textContent = token ? "✅ GitHub Connected" : "⚠️ No GitHub Token";
}

// --- GitHub Token Startup ---
async function checkTokenOnStartup() {
  let token = localStorage.getItem('githubToken');
  if (!token) {
    token = prompt("⚠️ GitHub token missing! Please enter your GitHub token:");
    if (token) {
      localStorage.setItem('githubToken', token);
      updateTokenStatus(token);
      await restoreFromGitHub();
    } else {
      alert("You can also load a GitHub token from a .txt file using Admin → Load Token From File.");
    }
  } else {
    updateTokenStatus(token);
    await restoreFromGitHub();
  }
  return token;
}

// --- Load Token From File ---
function handleLoadTokenFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async () => {
    const token = reader.result.trim();
    if (token) {
      localStorage.setItem('githubToken', token);
      updateTokenStatus(token);
      alert('✅ GitHub token loaded! Restoring list...');
      await restoreFromGitHub();
    } else alert('❌ Token file empty.');
  };
  reader.readAsText(file);
}

// --- GitHub Functions ---
async function saveToGitHub(silent=false) {
  let token = localStorage.getItem('githubToken');
  if(!token) token = await checkTokenOnStartup();
  if(!token) return;
  const content = btoa(unescape(encodeURIComponent(JSON.stringify({groceryItems,checkedAisle},null,2))));
  const apiUrl = `https://api.github.com/repos/${githubUser}/${repoName}/contents/${filePath}`;
  try {
    const res = await fetch(apiUrl,{headers:{Authorization:`token ${token}`,Accept:"application/vnd.github.v3+json"}});
    const data = res.ok ? await res.json() : {};
    const sha = data.sha || null;
    const response = await fetch(apiUrl,{
      method:'PUT',
      headers:{"Authorization":`token ${token}`,"Content-Type":"application/json"},
      body:JSON.stringify({message:"Update grocery list",content,sha})
    });
    if(!silent){ response.ok ? alert("✅ Uploaded to GitHub!") : alert("❌ Failed to upload"); }
  } catch(e){ console.error(e); if(!silent) alert("❌ Error uploading"); }
}

async function restoreFromGitHub(){
  const token = localStorage.getItem('githubToken');
  if(!token) return;
  try{
    const response = await fetch(`https://api.github.com/repos/${githubUser}/${repoName}/contents/${filePath}`,{headers:{Authorization:`token ${token}`,Accept:"application/vnd.github.v3+json"}});
    if(!response.ok) throw new Error("Fetch failed");
    const data = await response.json();
    const decoded = atob(data.content);
    const jsonData = JSON.parse(decoded);
    groceryItems = jsonData.groceryItems || [];
    checkedAisle = jsonData.checkedAisle || [];
    saveData(); renderMaster(); renderChecked();
    alert("✅ Restored from GitHub!");
  }catch(e){ console.error(e); alert("❌ Could not restore from GitHub"); }
}

// --- Render Lists ---
function renderMaster(filter=""){
  const list=document.getElementById('groceryList');
  list.innerHTML='';
  sortByAisle(groceryItems);
  groceryItems.forEach((item,index)=>{
    if(filter && !item.name.toLowerCase().includes(filter.toLowerCase())) return;
    const li=document.createElement('li'); li.className='item';
    const left=document.createElement('div');
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=item.checked||false;
    cb.addEventListener('change',()=>{ item.checked=cb.checked; saveData(); });
    const text=document.createElement('span'); text.textContent=`${item.name} (Aisle: ${item.aisle})`;
    left.appendChild(cb); left.appendChild(text);
    const btns=document.createElement('div');
    const editBtn=document.createElement('button'); editBtn.textContent='Edit';
    editBtn.addEventListener('click',()=>{
      const newName=prompt("Edit item:",item.name); if(newName!==null)item.name=newName.trim();
      const newAisle=prompt("Edit aisle:",item.aisle); if(newAisle!==null)item.aisle=newAisle.trim();
      renderMaster(document.getElementById('searchInput').value); saveData();
    });
    const removeBtn=document.createElement('button'); removeBtn.textContent='Remove';
    removeBtn.addEventListener('click',()=>{ groceryItems.splice(index,1); saveData(); renderMaster(document.getElementById('searchInput').value); });
    btns.appendChild(editBtn); btns.appendChild(removeBtn);
    li.appendChild(left); li.appendChild(btns);
    list.appendChild(li);
  });
}

function renderChecked(){
  const list=document.getElementById('checkedList'); list.innerHTML='';
  sortByAisle(checkedAisle);
  checkedAisle.forEach((item,i)=>{
    const li=document.createElement('li'); li.className='item';
    if(item.done) li.classList.add('checked');
    const left=document.createElement('div');
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=item.done||false;
    cb.addEventListener('change',()=>{
      item.done=cb.checked;
      if(cb.checked){ li.classList.add('checked'); checkedAisle.push(checkedAisle.splice(i,1)[0]); }
      else { li.classList.remove('checked'); }
      saveData(); renderChecked();
    });
    const span=document.createElement('span'); span.textContent=`${item.name} (Aisle: ${item.aisle})`;
    left.appendChild(cb); left.appendChild(span);
    li.appendChild(left); list.appendChild(li);
  });
}

// --- Add Item ---
async function addItem(){
  const name=document.getElementById('itemInput').value.trim();
  const aisle=document.getElementById('aisleInput').value.trim();
  if(!name) return;
  if(groceryItems.some(i=>i.name.toLowerCase()===name.toLowerCase())) return alert("Item already exists!");
  groceryItems.push({name,aisle,checked:false});
  document.getElementById('itemInput').value=''; document.getElementById('aisleInput').value='';
  saveData(); renderMaster(document.getElementById('searchInput').value);
  await saveToGitHub(true); // silent auto-export
}

// --- Helpers ---
function clearAllChecks(){ groceryItems.forEach(i=>i.checked=false); saveData(); renderMaster(document.getElementById('searchInput').value); }
function showMaster(){ document.getElementById('masterPage').classList.remove('hidden'); document.getElementById('checkedPage').classList.add('hidden'); document.getElementById('addPage').classList.add('hidden'); }
function showChecked(){ checkedAisle=groceryItems.filter(i=>i.checked).map(i=>({name:i.name,aisle:i.aisle,done:false})); saveData(); renderChecked(); document.getElementById('masterPage').classList.add('hidden'); document.getElementById('checkedPage').classList.remove('hidden'); document.getElementById('addPage').classList.add('hidden'); }
function showAdd(){ document.getElementById('addPage').classList.remove('hidden'); document.getElementById('masterPage').classList.add('hidden'); document.getElementById('checkedPage').classList.add('hidden'); }

const searchInput=document.getElementById('searchInput');
const clearSearchBtn=document.getElementById('clearSearchBtn');
searchInput.addEventListener('input', e=>{
  renderMaster(e.target.value);
  clearSearchBtn.style.display = e.target.value ? 'block' : 'none';
});
clearSearchBtn.addEventListener('click', ()=>{
  searchInput.value='';
  renderMaster();
  clearSearchBtn.style.display='none';
});

document.getElementById('addItemBtn').addEventListener('click', addItem);
document.getElementById('clearChecksBtn').addEventListener('click', clearAllChecks);
document.getElementById('showMasterBtn').addEventListener('click', showMaster);
document.getElementById('showCheckedBtn').addEventListener('click', showChecked);
document.getElementById('showAddBtn').addEventListener('click', showAdd);

document.getElementById('importListBtn').addEventListener('click',()=>document.getElementById('importListInput').click());
document.getElementById('importListInput').addEventListener('change', handleImportList);

document.getElementById('exportJsonBtn').addEventListener('click',()=>saveToGitHub(false));
document.getElementById('restoreGitHubBtn').addEventListener('click',restoreFromGitHub);

document.getElementById('setTokenBtn').addEventListener('click', async () => {
  const token = prompt("Enter your GitHub token:");
  if (token) {
    localStorage.setItem('githubToken', token);
    updateTokenStatus(token);
    await restoreFromGitHub();
  }
});

document.getElementById
document.getElementById('loadTokenFileBtn').addEventListener('click', () => {
  document.getElementById('tokenFileInput').click();
});
document.getElementById('tokenFileInput').addEventListener('change', handleLoadTokenFile);

// Import list from JSON/CSV
function handleImportList(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    let newItems=[];
    if(file.name.endsWith('.json')){
      try{ 
        const data=JSON.parse(e.target.result); 
        if(Array.isArray(data.groceryItems)) newItems=data.groceryItems; 
      } catch(err){ alert("Invalid JSON file"); return; }
    } else if(file.name.endsWith('.csv')){
      const lines=e.target.result.split(/\r?\n/).filter(Boolean);
      lines.forEach(line=>{
        const [name,aisle]=line.split(',').map(s=>s.trim());
        if(name) newItems.push({name,aisle});
      });
    } else { alert("Unsupported file type"); return; }

    const existingNames=new Set(groceryItems.map(i=>i.name.toLowerCase()));
    newItems.forEach(item=>{
      if(!existingNames.has(item.name.toLowerCase())) groceryItems.push({name:item.name, aisle:item.aisle||"", checked:false});
    });

    sortByAisle(groceryItems);
    saveData();
    renderMaster(document.getElementById('searchInput').value);
    alert(`✅ Imported ${newItems.length} new items (duplicates ignored) and sorted by aisle.`);
  };
  reader.readAsText(file);
}

// --- Init ---
document.addEventListener('DOMContentLoaded', async()=>{
  await checkTokenOnStartup();
  renderMaster();
  renderChecked();
});
</script>
</body>
</html>
