<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grocery Master List</title>
<style>
body { font-family: Arial, sans-serif; margin:10px; background:#f4f4f4; }
h1 { text-align:center; margin-bottom:5px; }
.menu { display:flex; gap:5px; justify-content:center; margin-bottom:10px; flex-wrap:wrap; }
.menu button, .menu .dropdown-btn { padding:8px 12px; border-radius:8px; border:none; background:#007bff; color:white; font-size:14px; cursor:pointer; }
.menu button:hover, .menu .dropdown-btn:hover { background:#0056b3; }
.status-icon { text-align:center; font-size:12px; color:#333; margin-bottom:2px; }
.button-bar { display:flex; flex-wrap:wrap; gap:5px; justify-content:flex-start; align-items:center; margin-bottom:10px; }
.button-bar button { padding:6px 10px; border-radius:6px; border:none; color:white; cursor:pointer; }
.button-bar .clear { background:#ffc107; color:#000; }
.button-bar .add { background:#17a2b8; }
.dropdown { position:relative; display:inline-block; }
.dropdown-content { display:none; position:absolute; background-color:#f9f9f9; min-width:160px; box-shadow:0 8px 16px rgba(0,0,0,0.2); z-index:1; border-radius:5px; }
.dropdown-content button { color:black; background:white; padding:8px 12px; width:100%; text-align:left; border:none; cursor:pointer; }
.dropdown-content button:hover { background:#ddd; }
.dropdown:hover .dropdown-content { display:block; }
.list-container { background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
.item { display:flex; justify-content:space-between; align-items:center; padding:6px; border-bottom:1px solid #ddd; }
.item.checked { text-decoration: line-through; color:gray; }
input[type="text"] { padding:5px; border-radius:5px; border:1px solid #ccc; margin-bottom:5px; }
#addPage { display:flex; flex-direction:column; gap:5px; flex-wrap:wrap; align-items:flex-start; margin-top:10px; }
.hidden { display:none; }
.search-container { position: relative; flex:1; max-width:300px; }
#searchInput { width:100%; padding-right: 25px; box-sizing: border-box; }
.clear-search { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; font-weight: bold; color: #888; font-size: 16px; display: none; }
.clear-search:hover { color: #333; }
.item button { margin-left:5px; padding:2px 6px; border-radius:4px; border:none; cursor:pointer; background:#007bff; color:white; font-size:12px; }
.item button:hover { background:#0056b3; }
</style>
</head>
<body>

<h1>Albertsons</h1>
<div id="tokenStatus" class="status-icon">⚠️ No GitHub Token</div>

<div class="menu">
  <button id="showMasterBtn">Albertsons</button>
  <button id="showCheckedBtn">Shopping List</button>
  <button id="showAddBtn">Add Items</button>
  <div class="dropdown">
    <button class="dropdown-btn">Admin ⏷</button>
    <div class="dropdown-content">
      <button id="exportJsonBtn">Export</button>
      <button id="restoreGitHubBtn">Restore</button>
      <button id="importListBtn">Import List</button>
      <button id="setTokenBtn">Set GitHub Token</button>
      <button id="loadTokenFileBtn">Load Token From File</button>
    </div>
  </div>
</div>

<div class="list-container">
  <div id="masterPage">
    <div class="button-bar">
      <button id="clearChecksBtn" class="clear">Clear All Checks</button>
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search items...">
        <span id="clearSearchBtn" class="clear-search">×</span>
      </div>
    </div>
    <ul id="groceryList"></ul>
  </div>

  <div id="checkedPage" class="hidden">
    <ul id="checkedList"></ul>
  </div>

  <div id="addPage" class="hidden">
    <input type="text" id="itemInput" placeholder="Item name">
    <input type="text" id="aisleInput" placeholder="Aisle">
    <button id="addItemBtn" class="add">Add Item</button>
  </div>
</div>

<input type="file" id="importListInput" accept=".json,.csv" style="display:none;">
<input type="file" id="tokenFileInput" accept=".txt" style="display:none;">

<script>
let groceryItems = [];
const githubUser = "509Eagle1";
const repoName = "Grocery";
const filePath = "data/grocery.json";

// ===== GitHub =====
async function saveToGitHub() {
  const token = localStorage.getItem("githubToken");
  if (!token) return;
  const apiUrl = `https://api.github.com/repos/${githubUser}/${repoName}/contents/${filePath}`;
  const content = btoa(unescape(encodeURIComponent(JSON.stringify({ groceryItems }, null, 2))));
  let sha = null;
  try {
    const check = await fetch(apiUrl, {
      headers: { Authorization: `token ${token}`, Accept: "application/vnd.github.v3+json" }
    });
    if (check.ok) sha = (await check.json()).sha;
    await fetch(apiUrl, {
      method: "PUT",
      headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify({ message: "Update grocery list", content, sha })
    });
  } catch (e) { console.error(e); }
}

async function restoreFromGitHub() {
  const token = localStorage.getItem('githubToken');
  if (!token) return;
  const apiUrl = `https://api.github.com/repos/${githubUser}/${repoName}/contents/${filePath}`;
  try {
    const res = await fetch(apiUrl, {
      headers: { Authorization: `token ${token}`, Accept: "application/vnd.github.v3+json" }
    });
    if (!res.ok) return;
    const data = await res.json();
    const jsonData = JSON.parse(atob(data.content));
    groceryItems = jsonData.groceryItems || [];
    renderMaster();
    renderChecked();
  } catch(e){ console.error(e); }
}

// ===== Token handling on startup =====
function promptTokenIfMissing() {
  let token = localStorage.getItem("githubToken");
  if (!token) {
    token = prompt("⚠️ GitHub token missing! Enter token:");
    if (token) localStorage.setItem("githubToken", token);
  }
  document.getElementById("tokenStatus").textContent = token ? "✅ GitHub Token Set" : "⚠️ No GitHub Token";
  if (token) restoreFromGitHub();
}

// ===== Render Master =====
function renderMaster(filter="") {
  const list = document.getElementById("groceryList");
  list.innerHTML = "";
  groceryItems.forEach((item, i) => {
    if(filter && !item.name.toLowerCase().includes(filter.toLowerCase())) return;

    const li = document.createElement("li");
    li.className = "item";

    const leftDiv = document.createElement("div");
    leftDiv.style.display = "flex"; leftDiv.style.alignItems = "center"; leftDiv.style.gap = "5px";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = item.checked || false;
    checkbox.addEventListener("change", () => {
      item.checked = checkbox.checked;
      renderChecked(); // live update Shopping List
      saveToGitHub();
    });

    const span = document.createElement("span");
    span.textContent = `${item.name} (Aisle: ${item.aisle})`;

    leftDiv.appendChild(checkbox);
    leftDiv.appendChild(span);
    li.appendChild(leftDiv);

    const btnDiv = document.createElement("div");

    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.onclick = () => {
      const newName = prompt("Edit item:", item.name);
      if (newName !== null) item.name = newName.trim();
      const newAisle = prompt("Edit aisle:", item.aisle);
      if (newAisle !== null) item.aisle = newAisle.trim();
      renderMaster();
      renderChecked();
      saveToGitHub();
    };

    const removeBtn = document.createElement("button");
    removeBtn.textContent = "Remove";
    removeBtn.onclick = () => { groceryItems.splice(i, 1); renderMaster(); renderChecked(); saveToGitHub(); };

    btnDiv.appendChild(editBtn);
    btnDiv.appendChild(removeBtn);
    li.appendChild(btnDiv);

    list.appendChild(li);
  });
}

// ===== Render Checked (Shopping List) =====
function renderChecked() {
  const list = document.getElementById("checkedList");
  list.innerHTML = "";

  groceryItems.filter(item => item.checked).forEach(item => {
    const li = document.createElement("li");
    li.className = "item";

    const leftDiv = document.createElement("div");
    leftDiv.style.display = "flex"; 
    leftDiv.style.alignItems = "center"; 
    leftDiv.style.gap = "5px";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = false; // always unchecked
    checkbox.disabled = true; // purely visual, cannot check

    const span = document.createElement("span");
    span.textContent = `${item.name} (Aisle: ${item.aisle})`;

    leftDiv.appendChild(checkbox);
    leftDiv.appendChild(span);
    li.appendChild(leftDiv);
    list.appendChild(li);
  });
}

// ===== Add Item =====
document.getElementById("addItemBtn").onclick = async () => {
  const name = document.getElementById("itemInput").value.trim();
  const aisle = document.getElementById("aisleInput").value.trim();
  if (!name) return;
  if (!groceryItems.some(i=>i.name.toLowerCase()===name.toLowerCase())){
    groceryItems.push({ name, aisle, checked: false });
    renderMaster(); renderChecked();
    await saveToGitHub();
  } else alert("Item already exists!");
  document.getElementById("itemInput").value = "";
  document.getElementById("aisleInput").value = "";
};

// ===== Menu Buttons =====
document.getElementById("clearChecksBtn").onclick = () => {
  groceryItems.forEach(i=>i.checked=false);
  renderMaster(); renderChecked();
  saveToGitHub();
};
document.getElementById("showMasterBtn").onclick = () => { document.getElementById('masterPage').classList.remove('hidden'); document.getElementById('checkedPage').classList.add('hidden'); document.getElementById('addPage').classList.add('hidden'); };
document.getElementById("showCheckedBtn").onclick = () => { document.getElementById('masterPage').classList.add('hidden'); document.getElementById('checkedPage').classList.remove('hidden'); document.getElementById('addPage').classList.add('hidden'); renderChecked(); };
document.getElementById("showAddBtn").onclick = () => { document.getElementById('addPage').classList.remove('hidden'); document.getElementById('masterPage').classList.add('hidden'); document.getElementById('checkedPage').classList.add('hidden'); };
document.getElementById("setTokenBtn").onclick = promptTokenIfMissing;
document.getElementById("loadTokenFileBtn").onclick = () => document.getElementById("tokenFileInput").click();
document.getElementById("tokenFileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const token = reader.result.trim();
    if(token){
      localStorage.setItem("githubToken", token);
      promptTokenIfMissing();
    } else alert("Empty token file");
  };
  reader.readAsText(file);
});

// ===== Search =====
const searchInput = document.getElementById("searchInput");
const clearSearchBtn = document.getElementById("clearSearchBtn");
searchInput.addEventListener("input", e => { renderMaster(e.target.value); clearSearchBtn.style.display=e.target.value?'block':'none'; });
clearSearchBtn.addEventListener("click", ()=>{ searchInput.value=''; renderMaster(); clearSearchBtn.style.display='none'; });

// ===== Init =====
document.addEventListener("DOMContentLoaded", ()=>{ promptTokenIfMissing(); renderMaster(); renderChecked(); });
</script>
</body>
</html>
