<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Master Grocery List</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
  header { background:#2c3e50; color:#fff; padding:10px; text-align:center; }
  nav { display:flex; justify-content:center; gap:10px; background:#34495e; padding:10px; flex-wrap:wrap; }
  nav button { padding:8px 14px; border:none; border-radius:6px; background:#3498db; color:#fff; cursor:pointer; }
  nav button:hover { background:#2980b9; }
  .container { padding:15px; max-width:600px; margin:auto; }
  .hidden { display:none; }
  ul { list-style:none; padding:0; margin:0; }
  li { background:#fff; margin:8px 0; padding:10px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .item-left { display:flex; align-items:center; gap:10px; }
  .btns { display:flex; gap:6px; }
  button.edit, button.remove, button.clear, button.add, button.save { padding:6px 10px; border:none; border-radius:4px; cursor:pointer; color:white; margin-top:0; }
  button.edit { background:#27ae60; }
  button.remove { background:#e74c3c; }
  button.clear { background:#f39c12; }
  button.add { background:#2ecc71; }
  button.save { background:#8e44ad; }
  input[type="text"] { padding:6px; margin:5px 0; width:100%; border:1px solid #ccc; border-radius:4px; }
  label { font-weight:bold; }
  .checked-list li { transition: all 0.4s ease; }
  .checked { text-decoration: line-through; color:#777; }
  .top-buttons { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; justify-content:center; }
</style>
</head>
<body>
<header><h2>Master Grocery List</h2></header>

<nav>
  <button id="showMasterBtn">Master List</button>
  <button id="showCheckedBtn">Checked by Aisle</button>
  <button id="showAddBtn">Add New Items</button>
</nav>

<div class="container">

  <div id="masterPage">
    <div class="top-buttons">
      <button id="clearChecksBtn" class="clear">Clear All Checks</button>
      <button id="exportListBtn" class="save">Export JSON</button>
      <button id="importFileBtn" class="save">Import JSON/CSV</button>
    </div>
    <input type="text" id="searchInput" placeholder="Search items...">
    <ul id="groceryList"></ul>
    <input type="file" id="importFileInput" accept=".json,.csv" style="display:none;">
  </div>

  <div id="checkedPage" class="hidden">
    <ul id="checkedList" class="checked-list"></ul>
  </div>

  <div id="addPage" class="hidden">
    <label>Item:</label>
    <input type="text" id="itemInput">
    <label>Aisle:</label>
    <input type="text" id="aisleInput">
    <button id="addItemBtn" class="add">Add Item</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let groceryItems = JSON.parse(localStorage.getItem("groceryItems") || "[]");
  let checkedAisle = JSON.parse(localStorage.getItem("checkedAisle") || "[]");

  function saveData() {
    localStorage.setItem("groceryItems", JSON.stringify(groceryItems));
    localStorage.setItem("checkedAisle", JSON.stringify(checkedAisle));
  }

  function sortByAisle(arr) {
    return arr.sort((a,b)=>a.aisle.localeCompare(b.aisle, undefined, {numeric:true, sensitivity:'base'}));
  }

  function renderMaster(filter="") {
    const list = document.getElementById('groceryList');
    list.innerHTML = '';
    sortByAisle(groceryItems);
    groceryItems.forEach((item,index)=>{
      if(filter && !item.name.toLowerCase().includes(filter.toLowerCase())) return;
      const li = document.createElement('li');
      const left = document.createElement('div'); left.className='item-left';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=item.checked||false;
      cb.addEventListener('change',()=>{ item.checked=cb.checked; saveData(); });
      const text = document.createElement('span'); text.textContent=`${item.name} (Aisle: ${item.aisle})`;
      left.appendChild(cb); left.appendChild(text);

      const btns = document.createElement('div'); btns.className='btns';
      const editBtn=document.createElement('button'); editBtn.textContent='Edit'; editBtn.className='edit';
      editBtn.onclick=()=>{
        const newName=prompt("Edit item:",item.name); if(newName!==null) item.name=newName.trim();
        const newAisle=prompt("Edit aisle:",item.aisle); if(newAisle!==null) item.aisle=newAisle.trim();
        renderMaster();
        saveData();
      };
      const removeBtn=document.createElement('button'); removeBtn.textContent='Remove'; removeBtn.className='remove';
      removeBtn.onclick=()=>{ groceryItems.splice(index,1); saveData(); renderMaster(); };
      btns.appendChild(editBtn); btns.appendChild(removeBtn);
      li.appendChild(left); li.appendChild(btns);
      list.appendChild(li);
    });
  }

  function renderChecked() {
    const list=document.getElementById('checkedList');
    list.innerHTML='';
    sortByAisle(checkedAisle);
    checkedAisle.forEach((item,i)=>{
      const li=document.createElement('li');
      const left=document.createElement('div'); left.className='item-left';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=item.done||false;
      cb.onchange=()=>{
        item.done=cb.checked;
        const done = checkedAisle.filter(i=>i.done);
        const undone = checkedAisle.filter(i=>!i.done);
        checkedAisle=[...undone,...done]; // move checked to bottom
        saveData();
        renderChecked();
      };
      const span=document.createElement('span'); span.textContent=`${item.name} (Aisle: ${item.aisle})`;
      if(item.done) li.classList.add('checked');
      left.appendChild(cb); left.appendChild(span); li.appendChild(left);
      list.appendChild(li);
    });
  }

  function addItem(){
    const name=document.getElementById('itemInput').value.trim();
    const aisle=document.getElementById('aisleInput').value.trim();
    if(!name) return;
    const exists=groceryItems.some(g=>g.name.toLowerCase()===name.toLowerCase() && g.aisle.toLowerCase()===aisle.toLowerCase());
    if(!exists) groceryItems.push({name,aisle,checked:false});
    document.getElementById('itemInput').value=''; document.getElementById('aisleInput').value='';
    saveData(); renderMaster();
  }

  function clearAllChecks(){ groceryItems.forEach(i=>i.checked=false); saveData(); renderMaster(); }
  function showMaster(){ document.getElementById('masterPage').classList.remove('hidden'); document.getElementById('checkedPage').classList.add('hidden'); document.getElementById('addPage').classList.add('hidden'); }
  function showChecked(){ checkedAisle=groceryItems.filter(i=>i.checked).map(i=>({...i,done:false})); saveData(); renderChecked(); document.getElementById('checkedPage').classList.remove('hidden'); document.getElementById('masterPage').classList.add('hidden'); document.getElementById('addPage').classList.add('hidden'); }
  function showAdd(){ document.getElementById('addPage').classList.remove('hidden'); document.getElementById('masterPage').classList.add('hidden'); document.getElementById('checkedPage').classList.add('hidden'); }

  // GitHub push with saved token
  async function pushToGitHub(token) {
    const owner = "YOUR_USERNAME";     
    const repo = "grocery-list";       
    const path = "data/grocery.json";  
    const content = btoa(unescape(encodeURIComponent(JSON.stringify({ groceryItems, checkedAisle }, null, 2))));
    let sha = null;

    try {
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        headers: { 'Authorization': `token ${token}` }
      });
      if (res.ok) {
        const data = await res.json();
        sha = data.sha;
      }
    } catch(e){ console.warn("File may not exist, creating new file."); }

    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method:'PUT',
      headers:{ 'Authorization': `token ${token}`, 'Content-Type':'application/json' },
      body: JSON.stringify({ message: "Update grocery list", content: content, sha: sha })
    });

    const result = await response.json();
    if (!response.ok) {
      console.error(result);
      alert("GitHub push failed: " + (result.message || response.statusText));
    } else {
      alert("Grocery list successfully pushed to GitHub!");
    }
  }

  async function exportAndPush() {
    const blob = new Blob([JSON.stringify({ groceryItems, checkedAisle }, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'grocery-list.json'; a.click(); URL.revokeObjectURL(a.href);

    let token = localStorage.getItem("githubToken");
    if (!token) {
      token = prompt("Enter your GitHub Personal Access Token (with repo permissions)");
      if (token) localStorage.setItem("githubToken", token);
    }

    if (token) await pushToGitHub(token);
  }

  function importFile(file){
    const reader=new FileReader();
    reader.onload=e=>{
      const text=e.target.result;
      if(file.name.endsWith('.json')){
        const data=JSON.parse(text);
        if(Array.isArray(data.groceryItems)){
          data.groceryItems.forEach(item=>{
            const exists=groceryItems.some(g=>g.name.toLowerCase()===item.name.toLowerCase() && g.aisle.toLowerCase()===item.aisle.toLowerCase());
            if(!exists) groceryItems.push({...item, checked:false});
          });
        }
        if(Array.isArray(data.checkedAisle)){
          data.checkedAisle.forEach(item=>{
            const exists=checkedAisle.some(g=>g.name.toLowerCase()===item.name.toLowerCase() && g.aisle.toLowerCase()===item.aisle.toLowerCase());
            if(!exists) checkedAisle.push({...item, done:false});
          });
        }
      } else if(file.name.endsWith('.csv')){
        const lines=text.split(/\r?\n/).filter(l=>l.trim());
        lines.forEach(line=>{
          const [name, aisle]=line.split(',').map(s=>s.trim());
          if(name){
            const exists=groceryItems.some(g=>g.name.toLowerCase()===name.toLowerCase() && g.aisle.toLowerCase()===aisle.toLowerCase());
            if(!exists) groceryItems.push({name,aisle:aisle||'',checked:false});
          }
        });
      } else { alert("Unsupported file type"); }
      sortByAisle(groceryItems);
      saveData(); renderMaster();
    };
    reader.readAsText(file);
  }

  // Event listeners
  document.getElementById('addItemBtn').addEventListener('click', addItem);
  document.getElementById('showMasterBtn').addEventListener('click', showMaster);
  document.getElementById('showCheckedBtn').addEventListener('click', showChecked);
  document.getElementById('showAddBtn').addEventListener('click', showAdd);
  document.getElementById('clearChecksBtn').addEventListener('click', clearAllChecks);
  document.getElementById('exportListBtn').addEventListener('click', exportAndPush);

  document.getElementById('importFileBtn').addEventListener('click', ()=>document.getElementById('importFileInput').click());
  document.getElementById('importFileInput').addEventListener('change', e=>{
    if(e.target.files.length) importFile(e.target.files[0]);
  });

  document.getElementById('searchInput').addEventListener('input', e=>renderMaster(e.target.value));
  document.getElementById('itemInput').addEventListener('keypress', e=>{ if(e.key==='Enter') addItem(); });

  renderMaster();
});
</script>
</body>
</html>
